generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  firstName         String?
  lastName          String?
  phoneNumber       String?
  dateOfBirth       DateTime?
  mobile            String
  password          String
  role              String              @default("user")  // user, admin, super_admin
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now()) @updatedAt
  blogs             Blog[]              @relation("AuthorBlogs")
  loanApplications  LoanApplication[]
  documents         UserDocument[]
  adminProfile      AdminProfile?       @relation("AdminUser")
  comments          Comment[]           @relation("CommentAuthor")
  auditLogs         AuditLog[]          @relation("AuditInitiator")
}

model AdminProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation("AdminUser", fields: [userId], references: [id], onDelete: Cascade)
  
  adminTitle      String?
  department      String?
  bio             String?
  profileImage    String?
  
  canApproveBlogs Boolean   @default(false)
  canManageUsers  Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
}

model Blog {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  excerpt         String
  content         String    @db.Text
  category        String
  
  authorId        String?
  author          User?     @relation("AuthorBlogs", fields: [authorId], references: [id], onDelete: SetNull)
  authorName      String
  authorImage     String?
  authorRole      String?
  
  featuredImage   String?
  readTime        Int       @default(5)
  views           Int       @default(0)
  isFeatured      Boolean   @default(false)
  
  status          String    @default("draft")  // draft, pending, published
  visibility      String    @default("private")  // private, public
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  
  comments        Comment[]
  tags            BlogTag[]
  auditLogs       AuditLog[]  @relation("BlogAuditLogs")
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([authorId])
  @@index([status])
  @@index([visibility])
  @@index([isPublished])
  @@index([isFeatured])
  @@index([category])
  @@index([publishedAt])
}

model Comment {
  id        String    @id @default(uuid())
  blogId    String
  blog      Blog      @relation(fields: [blogId], references: [id], onDelete: Cascade)
  
  userId    String?
  user      User?     @relation("CommentAuthor", fields: [userId], references: [id], onDelete: SetNull)
  
  author    String
  content   String    @db.Text
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  
  status    String    @default("approved")  // pending, approved, spam
  likes     Int       @default(0)
  likesData CommentLike[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  
  @@index([blogId])
  @@index([userId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String   // IP address or user identifier for anonymous likes
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id])

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  blogs     BlogTag[]
}

model BlogTag {
  blogId String
  tagId  String
  blog   Blog @relation(fields: [blogId], references: [id])
  tag    Tag  @relation(fields: [tagId], references: [id])

  @@id([blogId, tagId])
  @@index([tagId])
}

model LoanApplication {
  id        String   @id @default(uuid())
  userId    String
  bank      String
  loanType  String   // education, home, personal, business, vehicle
  amount    Float
  purpose   String?
  status    String   @default("pending") // pending, processing, approved, rejected
  date      DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

model UserDocument {
  id        String   @id @default(uuid())
  userId    String
  docType   String   // aadhar, pan, passport, 10th, 12th, degree
  uploaded  Boolean  @default(false)
  status    String   @default("pending") // pending, uploaded, verified, rejected
  filePath  String?
  uploadedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, docType])
  @@index([userId])
  @@index([docType])
}

model AuditLog {
  id            String   @id @default(uuid())
  action        String   // create, update, publish, delete
  entityType    String   // blog, user, comment
  entityId      String
  
  initiatedBy   String
  initiator     User     @relation("AuditInitiator", fields: [initiatedBy], references: [id], onDelete: SetNull)
  
  changes       Json
  ipAddress     String?
  userAgent     String?
  
  blog          Blog?    @relation("BlogAuditLogs", fields: [entityId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime @default(now())
  
  @@index([entityType])
  @@index([entityId])
  @@index([initiatedBy])
  @@index([createdAt])
}
